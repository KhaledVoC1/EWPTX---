# الجلسة 13: تخطي المصادقة الثنائية - 2FA Bypass
## Slides 181 → 193

---

## Slide 181-182: تعريف الـ 2FA

> **Two-Factor Authentication (2FA)** هي طبقة أمان إضافية بتتطلب من المستخدم يتحقق من هويته باستخدام **عاملين مختلفين** قبل ما يدخل النظام. العوامل دي عادةً:
> - **حاجة أنت تعرفها** (باسورد أو PIN)
> - **حاجة معاك** (موبايل أو Hardware Token)

### ليه الـ 2FA مش كافي لوحده؟

الـ 2FA بيقلل خطر الوصول غير المصرح به بشكل كبير. بس **مش مستحيل التخطي**. فيه تقنيات وثغرات في التنفيذ (Implementation) ممكن تسمح للمهاجم يعدّي من الـ 2FA.

---

## Slide 183-184: أنواع الـ 2FA

| النوع | آلية العمل | المميزات | العيوب |
|-------|-----------|---------|-------|
| **SMS-based** | OTP بيتبعت في رسالة SMS | سهل الاستخدام، منتشر | عرضة لـ SIM Swapping, Interception, Phishing |
| **Email-based** | OTP أو رابط تأكيد بيتبعت على الإيميل | مش محتاج موبايل | خطر لو الإيميل نفسه مخترق |
| **TOTP** | كود بيتولّد كل 30 ثانية (Google Authenticator) | أأمن من SMS | محتاج إعداد مسبق + جهاز تاني |
| **Authenticator Apps** | زي Microsoft Authenticator / Authy | مفيش اعتماد على قنوات خارجية | لو الجهاز اتفقد أو اتكسر = مشكلة |

---

## Slide 185: تقنيات تخطي 2FA - Social Engineering

### 1. Phishing

```
1. المهاجم بيعمل صفحة Login مزيفة شبه الأصلية
2. الضحية بتسجل دخول في الصفحة المزيفة
3. المهاجم بيأخد البيانات ويستخدمها في الموقع الحقيقي
4. الموقع الحقيقي بيبعت OTP للضحية
5. الصفحة المزيفة بتطلب الـ OTP من الضحية
6. الضحية بتكتبه ← المهاجم بيستخدمه فوراً!
```

أداة **Evilginx** بتعمل ده بشكل آلي — بتعمل Reverse Proxy بين الضحية والموقع الأصلي.

### 2. Vishing (Voice Phishing)

المهاجم بيتصل بالضحية ويدّعي إنه من الدعم الفني ويطلب الـ OTP.

### 3. SMiShing (SMS Phishing)

رسالة SMS مزيفة فيها لينك لصفحة مزيفة بتطلب الـ OTP.

---

## Slide 185 (تكملة): تقنيات تخطي 2FA - Implementation Flaws

### ثغرات في التنفيذ:

| الثغرة | الشرح |
|--------|-------|
| **Weak Backup Mechanisms** | آليات الاسترداد (أسئلة أمنية، Backup Codes) بتكون أضعف من الـ 2FA نفسه |
| **Session Fixation** | المهاجم يثبّت Session ID قبل الـ 2FA ← يسرق الجلسة بعد تسجيل الدخول |
| **Poor Token Validation** | الـ OTP مش بيتحقق منه صح — ممكن يتعاد استخدامه أو يتلاعب فيه |

---

## Slide 186: تقنيات تخطي 2FA - Token Interception

| التقنية | الشرح |
|---------|-------|
| **MITM Attack** | اعتراض الـ OTP أثناء النقل لو مش مشفر |
| **SIM Swapping** | المهاجم بيقنع شركة الاتصالات تنقل الرقم لـ SIM جديدة — يستلم الـ OTP |
| **SSL Stripping** | تحويل HTTPS لـ HTTP لاعتراض الـ OTP |

> SIM Swapping ده من أخطر الهجمات — حصلت حالات كتير فعلية. في 2019، حساب CEO Twitter (Jack Dorsey) اتسرق عن طريق SIM Swap.

---

## Slide 187-188: منهجية اختبار 2FA

### Phase 1: Information Gathering

```
1. حدد نوع الـ 2FA المستخدم (SMS, TOTP, App, Email)
2. افهم الـ Login Flow بالكامل:
   - مرحلة إدخال الباسورد
   - مرحلة إدخال الـ OTP
   - مرحلة الـ Recovery
3. ادرس إعدادات الـ 2FA:
   - طول الـ OTP (4, 6, 8 أرقام)
   - مدة صلاحيته (30 ثانية، دقيقة، 5 دقايق)
   - هل فيه Rate Limiting
```

### Phase 2: Testing Authentication Flow

| الاختبار | الهدف |
|---------|-------|
| **OTP Strength** | هل الـ OTP قصير أو متوقع؟ هل بينتهي بعد الاستخدام؟ |
| **Token Replay** | هل OTP قديم بيتقبل تاني؟ |
| **Network Security** | هل الـ OTP بيتبعت عبر HTTPS ولا HTTP؟ |

```
# اختبار Token Replay:
1. سجل دخول واحصل على OTP
2. استخدمه مرة → نجح
3. استخدم نفس الـ OTP مرة تانية → هل نجح؟
   لو نجح → Token Replay Vulnerability!
```

### Phase 3: Rate Limiting and Lockout

```bash
# اختبار Brute Force على OTP:
# لو الـ OTP 4 أرقام = 10,000 احتمال فقط!

# باستخدام Burp Intruder:
1. ابعت الـ OTP Verification Request للـ Intruder
2. حط Payload على الـ OTP field
3. استخدم قائمة من 0000 لـ 9999
4. شغّل — لو مفيش Rate Limiting هيلاقي الصح!
```

| طول الـ OTP | عدد الاحتمالات | Brute Force Time (بدون Rate Limiting) |
|------------|---------------|--------------------------------------|
| 4 أرقام | 10,000 | ثواني |
| 6 أرقام | 1,000,000 | دقايق |
| 8 أرقام | 100,000,000 | ساعات |

### Phase 4: Advanced Techniques

| التقنية | الشرح |
|---------|-------|
| **OAuth/OpenID Issues** | ثغرات في OAuth بتسمح بتخطي 2FA |
| **Replay Attacks** | استخدام OTP في أماكن مختلفة (Login, Payment) |
| **Client-Side Validation** | لو التحقق من الـ OTP بيحصل في JavaScript ← يتخطى بسهولة |

---

## Slide 189-192: OTP Security

> **OTP (One-Time Password)** هي باسوردات مؤقتة أحادية الاستخدام بتتولّد وبتتبعت للمستخدم. ميزتها الأساسية إنها **حساسة للوقت** — بتنتهي بسرعة، فصعب على المهاجم يعيد استخدامها.

### أنواع OTP:

| النوع | آلية العمل |
|-------|-----------|
| **TOTP** | كود بيتولّد كل 30 ثانية بناءً على Shared Secret + الوقت الحالي |
| **SMS-based** | كود بيتبعت في رسالة نصية للموبايل |

### OTP Rate Limiting:

> **Rate Limiting** بيمنع محاولات Brute Force على الـ OTP — بيحدد عدد المحاولات المسموحة في فترة زمنية معينة.

| سياسة Rate Limiting | الفعالية |
|---------------------|---------|
| 3 محاولات ثم Lockout لمدة 15 دقيقة | قوية |
| 10 محاولات بدون Lockout | ضعيفة |
| مفيش Rate Limiting | معدومة - OTP يتكسر في ثواني |

---

## Slide 193: Lab Demo - Attacking Login Forms with OTP Security

### خطوات الـ Lab:

```
1. سجل دخول بباسورد صحيح → الموقع يطلب OTP
2. افحص الـ OTP Request في Burp Suite
3. جرب:
   a. Token Replay: استخدم نفس الـ OTP مرتين
   b. Brute Force: لو 4 أرقام — جرب 0000 لـ 9999
   c. Empty OTP: ابعت الـ Request من غير OTP
   d. Manipulation: جرب "000000" أو "999999"
4. لاحظ هل فيه Rate Limiting أو Account Lockout
5. وثّق كل النتائج
```

---

## ملخص الجلسة الثالثة عشر

| المفهوم | الشرح | الخطورة |
|---------|-------|---------|
| **2FA** | عاملين للتحقق (باسورد + OTP عادةً) | — |
| **SMS OTP** | كود عبر رسالة نصية | عرضة لـ SIM Swapping |
| **TOTP** | كود بيتغير كل 30 ثانية | أأمن، بس ممكن يتكسر |
| **Phishing / Evilginx** | صفحة مزيفة بتسرق الـ OTP في Real-Time | Critical |
| **SIM Swapping** | نقل الرقم لـ SIM جديدة | Critical |
| **Token Replay** | إعادة استخدام OTP قديم | High |
| **OTP Brute Force** | تخمين OTP من 4 أرقام (10K احتمال) | High لو مفيش Rate Limiting |
| **Rate Limiting** | تحديد عدد المحاولات | خط الدفاع الأساسي |

> الجلسة الجاية هي **الأخيرة** — ملخص شامل للكورس كله + الخطوات القادمة.
